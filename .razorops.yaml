global:
  runner: 
    containers:
    - image: razorci/golang:1.14
      environment:
      - DB_CONNECTION=mongodb://${DB_USER}:${DB_PASS}@${DB_HOST}:27017/${DB_NAME}
      - DB_NAME=${DB_NAME}
    - image: bitnami/mongodb:4.4.1
      environment:
      - MONGODB_ROOT_PASSWORD=${DB_ROOT_PASS}
      - MONGODB_DATABASE=${DB_NAME}
      - MONGODB_USERNAME=${DB_USER}
      - MONGODB_PASSWORD=${DB_PASS}

tasks:
  build:
    steps: 
    - docker/build:
       image: go-todo
      #  push: true

      #  tags: ["${CI_COMMIT_SHA}", "latest"]
       tags: [ "latest"]
       dockerfile: server/Dockerfile
       context: /server

  scanining:
    steps:
    - commands:
      - |
          apt-get install wget apt-transport-https gnupg
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb bionic main | tee -a /etc/apt/sources.list.d/trivy.list
          apt-get update
          apt-get install -y trivy
          trivy image --format template --template "@junit.tpl" -o junit-report.xml  go-todo:latest

  reports:  
    - reports/junit:
      paths: junit-report.xml

  test:
    steps:
    - checkout
    - commands:
      - |
        cd server
        export DB_CONNECTION=mongodb://${DB_USER}:${DB_PASS}@${DB_HOST}:27017/${DB_NAME}
        export DB_NAME=${DB_NAME}
        go mod download
        go test ./...
