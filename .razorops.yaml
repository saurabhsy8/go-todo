global:
  runner: 
    containers:
    - image: razorci/golang:1.14
      environment:
      - DB_CONNECTION=mongodb://${DB_USER}:${DB_PASS}@${DB_HOST}:27017/${DB_NAME}
      - DB_NAME=${DB_NAME}
    - image: bitnami/mongodb:4.4.1
      environment:
      - MONGODB_ROOT_PASSWORD=${DB_ROOT_PASS}
      - MONGODB_DATABASE=${DB_NAME}
      - MONGODB_USERNAME=${DB_USER}
      - MONGODB_PASSWORD=${DB_PASS}

tasks:
  build:
    steps: 
    - checkout
    - docker/build:
       image: saurabh3460/todo-app1
       push: true
      #  tags: ["${CI_COMMIT_SHA}", "latest"]
       tags: [ "latest"]
       dockerfile: server/Dockerfile
       context: server
    - commands:
      - |
          ls
          wget https://github.com/aquasecurity/trivy/releases/download/v0.30.3/trivy_0.30.3_Linux-64bit.deb
          sudo dpkg -i trivy_0.30.3_Linux-64bit.deb
          trivy image --format template --template "@junit.tpl" -o junit_report.xml  saurabh3460/todo-app1:latest
          cat junit_report.xml
    - reports/junit:
        paths: ["junit_report.xml"]
       
  # test:
  #   steps:
  #   - checkout
  #   - commands:
  #     - |
  #       cd server
  #       export DB_CONNECTION=mongodb://${DB_USER}:${DB_PASS}@${DB_HOST}:27017/${DB_NAME}
  #       export DB_NAME=${DB_NAME}
  #       go mod download
  #       go test ./...
